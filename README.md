# 🅿️ PenbunAPI v1.9.4 Stable

PenbunAPI is a RESTful API designed to manage the distribution and supply of books and stationery.  
It provides robust features for inventory management, order processing, and user authentication using JWT.

---

## 📘 Development Standards (v1.9.4)

### Core Principles (Thin API)

- API logic kept minimal: business rules, code generation, and timestamps handled by DB triggers and WinApp.
- Consistent response format across all endpoints.
- Transaction safety enforced via `utils.ExecuteTransaction`.

### Response Shape

```json
{
  "status": "success | error",
  "message": "short message",
  "data": { ... } // or null
}
```

### Database Conventions

- `update_date` handled by Trigger with `SE Asia Standard Time`.
- `is_delete BIT` (0 = No, 1 = Yes) for soft delete.
- `id_status BIT` (1 = Active, 0 = Inactive, default 1).
- Business codes generated by Trigger (e.g., `PTG000001`).

### CRUD Pattern

1. **Select All** – always `WHERE is_delete = 0`
2. **Select Page** – support `?page=&limit=` params
3. **Select By ID/Name** – allow `LIKE` searches
4. **Insert** – send only business fields, return minimal response (e.g. `{ "group_name": "LEGO" }`)
5. **Update** – use `COALESCE(NULLIF(...))` for partial updates
6. **Soft Delete** – mark `is_delete=1`, update_by recorded
7. **Hard Delete** – physical deletion

### Logging Standard

- Every transaction logged under `/logs/transactions/tx.log`.
- Format includes step count, duration, rollback/commit results.

### Example Response

```json
{
  "status": "success",
  "message": "Product type group updated successfully",
  "data": { "group_name": "LEGO Updated" }
}
```

---

## 🚀 Features

- **Authentication** – JWT-based secure access.
- **Publisher / Customer / Vendor / Discount / Book APIs** – Full CRUD + Paging + Search.
- **Consistent Master Data APIs** – All modules implement 8 standard functions.
- **Logging** – Transaction logs for audit.
- **Versioned API** – v1, v2 support.
- **Graceful Shutdown** – Safe server stop and cleanup.

---

## ⚙️ Fundamental Functions

Each master module has 8 functions:

| #   | Function         | Description                           |
| --- | ---------------- | ------------------------------------- |
| 1   | Select All       | All records with `is_delete = 0`      |
| 2   | Select By Paging | Query with `?page=&limit=`            |
| 3   | Select By ID     | Record by code/id                     |
| 4   | Select By Name   | Search by LIKE `%name%`               |
| 5   | Insert           | Add new record                        |
| 6   | Update By ID     | Update by ID (no auto fields touched) |
| 7   | Delete By ID     | Soft delete (is_delete=1)             |
| 8   | Remove By ID     | Hard delete                           |

---

## 🧩 **Project Structure**

```
PenbunAPI/
├── main.go
├── config/
│   ├── database.go           # Database connection setup
│   ├── blacklist.go          # Token blacklist
│   ├── env.go                # Environment variable management
│   └── logger.go             # Log configuration
│
├── controllers/
│   ├── auth.go               # Authentication endpoints
│   ├── books.go              # Book management endpoints
│   ├── publishers.go         # Publisher management endpoints
│   ├── publisherType.go      # Publisher Type management endpoints
│   ├── references.go         # Reference management endpoints
│   ├── customer.go           # Customer management endpoints
│   ├── customerType.go       # Customer Type management endpoints
│   ├── book.go               # Book management endpoints
│   ├── bookType.go           # Book Type management endpoints
│   ├── discountType.go       # Discount Type management endpoints
│   ├── discount.go           # Discount management endpoints
│   ├── unitType.go           # Product Type management endpoints
│   ├── productTypeGroup.go   # Product Type Group management endpoints
│   ├── productType.go        # Product Type management endpoints
│   ├── vendorType.go         # Vendor Type management endpoints
│   └── vendor.go             # Vendor management endpoints
│
├── models/
│   ├── user.go               # User-related structs and logic
│   ├── book.go               # Book-related structs and logic
│   ├── bookType.go           # Book Type-related structs and logic
│   ├── publisher.go          # Publisher-related structs and logic
│   ├── publisherType.go      # Publisher Type-related structs and logic
│   ├── references.go         # Reference-related structs and logic
│   ├── book.go               # Book management structs and logic
│   ├── bookType.go           # Book Type management structs and logic
│   ├── discountType.go       # Discount Type management structs and logic
│   ├── discount.go           # Discount management structs and logic
│   ├── unitType.go           # Product Type management endpoints
│   ├── productType.go        # Product Type management endpoints
│   ├── productTypeGroup.go   # Product Type Group management endpoints
│   ├── vendorType.go         # Vendor Type management structs and logic
│   └── vendor.go             # Vendor management structs and logic
│
├── routes/
│   ├── public.go             # Public API version routes
│   ├── v1.go                 # API version 1 routes and grouping
│   └── v2.go                 # API version 2 routes (placeholder)
│
├── middleware/
│   └── jwt.go                # JWT middleware for secure endpoints
│
├── logs/
│   └── transaction.log       # Log file for transactions
│
├── .env                      # Environment variables
│
└── go.mod                    # Go module file
```

---

## 💽 Libraries

- Fiber (Go Web Framework)
- go-mssqldb (SQL Server driver)
- golang-jwt (JWT)
- bcrypt (password hashing)
- godotenv (env loader)

---

## 💾 Installation

1. Clone repository
2. Run `go mod tidy`
3. Configure `.env` (DB credentials, JWT secret, log path)
4. Run server: `go run main.go`

---

## 🧪 Example Insert (ProductTypeGroup)

Request:

```json
{
  "group_name": "LEGO",
  "description": "กลุ่มสินค้าที่เกี่ยวข้องกับเลโก้ทุกประเภท",
  "update_by": "JACK"
}
```

Response:

```json
{
  "status": "success",
  "message": "Product type group added successfully",
  "data": { "group_name": "LEGO" }
}
```

---

## 💽 **Libraries and Frameworks**

### Backend Framework

- [Fiber](https://gofiber.io/) - High-performance web framework for Go.

### Authentication

- [JWT (golang-jwt)](https://github.com/golang-jwt/jwt) - JWT implementation in Go for secure authentication.

### Database

- [MSSQL (go-mssqldb)](https://github.com/denisenkom/go-mssqldb) - Microsoft SQL Server driver for Go.

### Hashing

- [Bcrypt (golang.org/x/crypto/bcrypt)](https://pkg.go.dev/golang.org/x/crypto/bcrypt) - Secure password hashing.

### Environment Variables

- [Godotenv](https://github.com/joho/godotenv) - Load environment variables from `.env` file.

### Logging

- Built-in `log` package in Go for lightweight logging.

## 💾 **Installation and Setup**

### Prerequisites

- Go (1.19 or higher)
- Microsoft SQL Server
- Git (optional, for cloning the repository)

### Steps

1. Clone the repository:

   ```bash
   git clone https://github.com/yourusername/PenbunAPI.git
   cd PenbunAPI
   ```

2. Install dependencies:

   ```bash
   go mod tidy
   ```

3. Configure the `.env` file:

   ```
   DB_HOST=your_db_host
   DB_PORT=1433
   DB_USER=your_db_user
   DB_PASSWORD=your_db_password
   DB_NAME=your_db_name
   JWT_SECRET=your_jwt_secret
   LOG_FILE=logs/transaction.log
   ```

4. Run the server:

   ```bash
   go run main.go
   ```

5. **Optional**: Create a new user using `bcrypt` for password hashing.
   Install `htpasswd`:
   ```bash
   sudo apt update
   sudo apt install apache2-utils -y
   ```
   Generate `bcrypt` hash:
   ```bash
   htpasswd -nbBC 10 username password
   ```
   Sample output:
   ```
   username:$2y$10$KfQ8mU5VvJ5QGk7/LN9OeOujOPEwLjD3Oo4yEWDwEpr6/LkfuPWoK
   ```
   Insert into Database:
   ```sql
   DELETE FROM tb_users;
   DBCC CHECKIDENT ('tb_users', RESEED, 0);
   INSERT INTO tb_users (user_name, user_password, user_level)
   VALUES ('username', '$2y$10$KfQ8mU5VvJ5QGk7/LN9OeOujOPEwLjD3Oo4yEWDwEpr6/LkfuPWoK', 'ADMIN');
   ```

## ©️ **License**

This project is licensed under the PENBUN License. See the LICENSE file for details.
